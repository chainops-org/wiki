# Платежи

Платежи облегчаются за счет поддержания баланса счета в смарт-контракте сети ssv, который ведет баланс для всех участников сети.


Аккаунты, созданные при регистрации валидаторов и операторов в сети, доступны и принадлежат тому адресу кошелька, который передал транзакцию. 

Это означает, что адрес является владельцем учетной записи, что позволяет ему управлять своим балансом и выбранными валидаторами/операторами.

Все остатки на счетах объединяются в смарт-контракте сети SSV, чтобы обеспечить расчет потоков платежей между участниками сети. 

Потоки поддерживаются путем отслеживания накопленных депозитов, снятий, доходов и расходов каждого пользователя, которые формируют баланс их счета.

Компоненты баланса рассчитываются по набору формул (изложенных ниже) каждый раз, когда происходит событие, влияющее на учетную запись этого пользователя. 

Каждый раз, когда происходит такое событие, компоненты баланса рассчитываются задним числом до текущего состояния, и делается новый снимок для использования в будущих расчетах.

![Alt text](/img/ssv/ssv_payments_1.jpeg)


Баланс счета состоит из 3 переменных и рассчитывается по:
:::info

$$
balance = d + r - e - w
$$

:::
                                                          
Где: 
* $d$ - депозиты 
* $r$ - доходы
* $e$ - расходы 
* $w$ - снятие средств


## Депозиты и Снятие средств ##

Чистые переводы депозитов и снятия средств, произведенные на баланс учетной записи пользователя.

## Доход ## 

Заработок, полученный операторами в качестве оплаты от стейкеров за работу своих валидаторов.

* Доход рассчитывается по сумме доходов от всех операторов

:::info

$$
Revenue =\sum{(e_{operators})}
$$

:::


Доход каждого оператора рассчитывается по формуле:
:::info

$$
e_{operators} = e_{p} + (b - b_{p}) * f * v
$$

:::

Где: 

* $e_{p}$ - ранее накопленный заработок
* $b$  - текущий блок
* $b_{p}$ - предыдущий блок
* $f$  - комиссия ($SSV за блок)
* $v$  - количество валидаторов, которыми управляет оператор


Доход рассчитывается для каждого оператора путем отслеживания их накопленного заработка ($e_p$) каждый раз, когда изменяется комиссия оператора ($f$) или при получении или потере валидатора ($v$).


## Затраты ##

Расходы представляют собой платежи операторам за управление их валидаторами и сетевые сборы, уплачиваемые сети.


* Расходы рассчитываются по сумме платежей операторам дополнительно к начисленным сетевым сборам:


:::info

$$
expenses = \sum{(p_{operators}) + p_{network}}
$$

:::


## Индексы: операторские и сетевые сборы ##

Индексы помогают отслеживать платежи в связи с текущими обновлениями сборов от сети и ее операторов.


Индексы хранятся отдельно для изменений сборов оператора и сети и представляют собой кривую изменения накопленных сборов с течением времени.

![Alt text](/img/ssv/ssv_payments_2.jpeg)

* Индексы рассчитываются по:

:::info

$$
index = index_{p} + (b - b_{p}) * f
$$

:::

где:

* $index$ - предыдущий индекс
* $b$ - текущий блок
* $b_{p}$- предыдущий блок
* $f$- комиссия ($SSV за блок)
  * Индекс оператора - комиссия оператора
  * Индекс платы за сеть — плата за протокол


Индексы рассчитываются путем отслеживания накопления комиссий с течением времени $index_{p}$ каждый раз, когда сеть или оператор меняют свою комиссию $(f)$.


**Индексы в платежах**

Каждая учетная запись в сети хранит индекс оператора и сети с момента, когда оператор (и сеть) начинает управлять своими валидаторами. 

Ссылка текущего $index$ оператора по отношению к предыдущему показателю ($index_p$) - при расчете платежа - позволяет договору определять расходы по счету изолированно, чтобы исключить его из деятельности других участников сети (например, частые изменения комиссий). 

Этот дизайн позволяет выполнять расчет изолированным образом, что оптимизирует производительность и стоимость исполнения контракта.



**Платежи**

* Оплата за каждого оператора рассчитывается по:

:::info

$$
p_{operator} = p_p + (i-i_p) * v
$$

:::

Где: 

* $P_p$ - ранее накопленные платежи
* *i*  - текущий индекс оператора
* *i_р* - предыдущий индекс оператора
* *v* - количество операторов валидаторов для пользователя (конкретного оператора)


Платежи рассчитываются для каждого оператора путем отслеживания его накопленных платежей () каждый раз, 
когда учетная запись меняет количество валидаторов () у оператора.

* Сетевой платеж за каждый аккаунт рассчитывается по формуле:

:::info

$$
p_{network} = p_p + (i-i_p) * v
$$

:::


Где: 

* $p_p$ - ранее накопленные платежи
* $i$  - текущий индекс платы за сеть
* $i_р$ - предыдущий индекс платы за сеть
* $v$ - количество оператора валидаторов для пользователя (по всем операторам)

Сетевые сборы рассчитываются для каждой учетной записи путем отслеживания накопленных сетевых сборов(Pp) каждый раз, когда учетная запись подключает новый валидатор к сети или покидает ее (v).

* **Пример сценария индексов**

![Alt text](/img/ssv/ssv_payments_3.jpeg)


* Боб зарегистрировал валидатор в сети, которым будет управлять Алиса, оператор в блоке 120:

  * $p_{alice}=0$, $p_p \rightarrow 0$, $i_p \rightarrow 200$, $v \rightarrow 1$

* В блоке 140 Боб зарегистрировал дополнительный валидатор, которым будет управлять Алиса:

  * $p_{alice}=0+(800−200)*1=600$, $p_p \rightarrow 600$, $i_p \rightarrow 800$, $v \rightarrow 2$

* В блоке 180 Боб решил заменить Алису на Еву для управления своими валидаторами — общая сумма платежей, которые Боб сделал Алисе, на данный момент составляет 3000:

  * $p_{alice}=600+(2000−800)*2=3000$, $p_p \rightarrow 3000$,$i_p \rightarrow 2000$, $v \rightarrow 0$

**Сетевые сборы**

Сборы, начисляемые в казну протокола от валидаторов за использование сети.

* Сетевые сборы рассчитываются по:

:::info

$$
Network\:fees = NF_p + (b - b_p) * f * v
$$

:::

Где:

* $NF_p$ - предыдущие накопленные сборы
* $b$  - текущий блок
* $b_p$ - предыдущий блок
* $f$  - комиссия ($SSV за блок)
* $v$ - количество валидаторов в сети

Сборы поддерживаются для всей сети, отслеживая накопленные сборы ($NF_p$) каждый раз, когда сетевой сбор изменяется ($f$) или когда сеть приобретает или теряет валидатор ($v$).

